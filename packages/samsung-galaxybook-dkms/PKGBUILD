# Maintainer: GalaxyOS Team
pkgname=samsung-galaxybook-dkms
pkgver=0.3
pkgrel=1
pkgdesc="Samsung Galaxy Book ACPI Platform Driver (DKMS)"
arch=('x86_64')
url="https://github.com/Huttysam/samsung-galaxybook-linux-unified"
license=('GPL2')
depends=('dkms')
makedepends=('git')
source=("git+https://github.com/Huttysam/samsung-galaxybook-linux-unified.git")
md5sums=('SKIP')

package() {
  # Create DKMS source directory
  install -d "${pkgdir}/usr/src/${pkgname}-${pkgver}"
  
  # Copy driver source
  cp -r "${srcdir}/samsung-galaxybook-linux-unified/samsung-galaxybook-driver/"* \
    "${pkgdir}/usr/src/${pkgname}-${pkgver}/"
  
  # Create DKMS configuration
  cat > "${pkgdir}/usr/src/${pkgname}-${pkgver}/dkms.conf" << 'EOF'
PACKAGE_NAME="samsung-galaxybook"
PACKAGE_VERSION="0.3"
CLEAN="make clean"
MAKE="make -C ${KERNEL_SRC} M=${dkms_tree}/${PACKAGE_NAME}/${PACKAGE_VERSION}/build"
BUILT_MODULE_NAME[0]="samsung-galaxybook"
DEST_MODULE_LOCATION[0]="/kernel/drivers/platform/x86"
AUTOINSTALL="yes"
EOF

  # Install udev rules
  install -d "${pkgdir}/etc/udev/rules.d"
  cat > "${pkgdir}/etc/udev/rules.d/99-samsung-galaxy.rules" << 'EOF'
# Galaxy Book keyboard backlight
SUBSYSTEM=="leds", KERNEL=="*kbd_backlight*", MODE="0666"
# Galaxy Book performance mode
SUBSYSTEM=="platform", KERNEL=="samsung-galaxybook", MODE="0666"
EOF

  # Install modprobe config
  install -d "${pkgdir}/etc/modprobe.d"
  echo "options samsung-galaxybook enable_platform_profile=1" > \
    "${pkgdir}/etc/modprobe.d/samsung-galaxybook.conf"
}
