jobs:
  build:
    runs-on: ubuntu-22.04
    container:
      image: archlinux:latest
      options: --privileged

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build tools
        run: |
          pacman -Sy --noconfirm --needed archiso git base-devel sudo

      - name: Build custom Samsung driver package
        run: |
          # Create build user for makepkg
          useradd -m builduser
          echo "builduser ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/builduser
          
          cd packages/samsung-galaxybook-dkms
          chown -R builduser:builduser .
          sudo -u builduser makepkg -s --noconfirm
          
          mkdir -p ../../profile/custom-repo
          cp *.pkg.tar.zst ../../profile/custom-repo/
          cd ../../profile/custom-repo
          repo-add custom.db.tar.zst *.pkg.tar.zst

      - name: Build ISO
        run: |
          cd profile
          mkarchiso -v -w /tmp/archiso-tmp -o ../out .

      - name: Rename ISO
        run: |
          cd out
          mv *.iso ${{ env.ISO_NAME }}-$(date +%Y.%m.%d).iso

      - name: Upload ISO Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ISO_NAME }}
          path: out/*.iso
          retention-days: 30jobs:
  build:
    runs-on: ubuntu-22.04
    container:
      image: archlinux:latest
      options: --privileged

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build tools
        run: |
          pacman -Sy --noconfirm --needed archiso git base-devel sudo

      - name: Build custom Samsung driver package
        run: |
          # Create build user for makepkg
          useradd -m builduser
          echo "builduser ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/builduser
          
          cd packages/samsung-galaxybook-dkms
          chown -R builduser:builduser .
          sudo -u builduser makepkg -s --noconfirm
          
          mkdir -p ../../profile/custom-repo
          cp *.pkg.tar.zst ../../profile/custom-repo/
          cd ../../profile/custom-repo
          repo-add custom.db.tar.zst *.pkg.tar.zst

      - name: Build ISO
        run: |
          cd profile
          mkarchiso -v -w /tmp/archiso-tmp -o ../out .

      - name: Rename ISO
        run: |
          cd out
          mv *.iso ${{ env.ISO_NAME }}-$(date +%Y.%m.%d).iso

      - name: Upload ISO Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ISO_NAME }}
          path: out/*.iso
          retention-days: 30
