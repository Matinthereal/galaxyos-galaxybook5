#!/bin/bash
# GalaxyOS First Boot Configuration
# Runs once on installed system

LOG_FILE="/var/log/galaxyos-firstboot.log"
exec > >(tee -a "$LOG_FILE") 2>&1

echo "=== GalaxyOS First Boot Setup ==="
date

# 1. Enable Samsung driver (should be loaded, but ensure it is)
modprobe samsung-galaxybook 2>/dev/null || echo "Samsung driver not available in live mode"

# 2. Audio fix service
cat > /etc/systemd/system/samsung-audio-fix.service << 'EOF'
[Unit]
Description=Samsung Galaxy Book Audio Fix (4-Speaker Setup)
After=sound.target pipewire.service

[Service]
Type=oneshot
ExecStart=/usr/local/bin/fix-samsung-audio
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable samsung-audio-fix.service

# 3. TLP Optimized Configuration for Galaxy Book 5
cat > /etc/tlp.conf << 'EOF'
# GalaxyBook 5 360 Optimized Settings
TLP_ENABLE=1
TLP_WARN_LEVEL=3

# CPU Governor
CPU_SCALING_GOVERNOR_ON_AC=performance
CPU_SCALING_GOVERNOR_ON_BAT=powersave
CPU_ENERGY_PERF_POLICY_ON_AC=balance_performance
CPU_ENERGY_PERF_POLICY_ON_BAT=balance_power

# CPU Boost (turbo)
CPU_BOOST_ON_AC=1
CPU_BOOST_ON_BAT=0

# Platform Profile (Samsung-specific)
PLATFORM_PROFILE_ON_AC=balanced
PLATFORM_PROFILE_ON_BAT=low-power

# Intel GPU (Arc 140V)
INTEL_GPU_MIN_FREQ_ON_AC=500
INTEL_GPU_MAX_FREQ_ON_AC=1950
INTEL_GPU_MIN_FREQ_ON_BAT=100
INTEL_GPU_MAX_FREQ_ON_BAT=800
INTEL_GPU_BOOST_FREQ_ON_AC=1950

# Battery Care (80% charge limit for longevity)
START_CHARGE_THRESH_BAT0=75
STOP_CHARGE_THRESH_BAT0=80

# PCIe Power Management
PCIE_ASPM_ON_AC=default
PCIE_ASPM_ON_BAT=powersupersave

# WiFi Power Save
WIFI_PWR_ON_AC=off
WIFI_PWR_ON_BAT=on

# USB Autosuspend
USB_AUTOSUSPEND=1

# Audio Power Save
SOUND_POWER_SAVE_ON_AC=0
SOUND_POWER_SAVE_ON_BAT=1

# Runtime PM
RUNTIME_PM_ON_AC=on
RUNTIME_PM_ON_BAT=auto
EOF

systemctl enable tlp.service

# 4. S Pen / Stylus Configuration
mkdir -p /etc/X11/xorg.conf.d/
cat > /etc/X11/xorg.conf.d/99-samsung-pen.conf << 'EOF'
Section "InputClass"
    Identifier "Samsung S Pen"
    MatchProduct "Wacom|ELAN|WACOM"
    MatchDevicePath "/dev/input/event*"
    Driver "wacom"
    Option "PressureCurve" "50,0,100,50"
    Option "Touch" "off"
    Option "Gesture" "off"
EndSection
EOF

# 5. Touchscreen / Tablet Mode
systemctl enable iio-sensor-proxy.service

# 6. Auto-rotation script
cat > /usr/local/bin/auto-rotate.sh << 'EOF'
#!/bin/bash
# Auto-rotation for Galaxy Book 360
monitor-sensor | while read -r line; do
    if echo "$line" | grep -q "Accelerometer"; then
        orientation=$(echo "$line" | grep -oP 'orientation: \K[^,]+')
        case "$orientation" in
            normal)
                xrandr --output eDP-1 --rotate normal
                ;;
            left-up)
                xrandr --output eDP-1 --rotate left
                ;;
            right-up)
                xrandr --output eDP-1 --rotate right
                ;;
            bottom-up)
                xrandr --output eDP-1 --rotate inverted
                ;;
        esac
    fi
done
EOF
chmod +x /usr/local/bin/auto-rotate.sh

# 7. Battery Threshold Service (80% limit)
cat > /etc/systemd/system/battery-threshold.service << 'EOF'
[Unit]
Description=Set Battery Charge Threshold to 80%
After=multi-user.target

[Service]
Type=oneshot
ExecStart=/bin/bash -c 'echo 80 > /sys/class/power_supply/BAT1/charge_control_end_threshold 2>/dev/null || echo 80 > /sys/class/power_supply/BAT0/charge_control_end_threshold 2>/dev/null || true'
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
EOF
systemctl enable battery-threshold.service

# 8. Gaming optimizations
systemctl enable --now gamemoded

# 9. Samsung-specific udev rules for non-root access
cat > /etc/udev/rules.d/99-samsung-galaxy.rules << 'EOF'
# Keyboard backlight control for user
SUBSYSTEM=="leds", KERNEL=="*kbd_backlight*", MODE="0666", TAG+="uaccess"

# Performance profile switching
SUBSYSTEM=="platform", KERNEL=="samsung-galaxybook", MODE="0666"

# Battery threshold (if exposed)
SUBSYSTEM=="power_supply", KERNEL=="BAT*", ATTR{type}=="Battery", MODE="0666"
EOF

udevadm control --reload-rules || true

# 10. Add user to important groups (if user exists)
if [ -n "$SUDO_USER" ]; then
    usermod -aG gamemode,input,video,power "$SUDO_USER" 2>/dev/null || true
fi

# 11. Fix for 400MHz throttling bug (ensure balanced profile loads correctly)
cat > /etc/systemd/system/fix-cpu-throttle.service << 'EOF'
[Unit]
Description=Fix 400MHz CPU throttling on Galaxy Book
After=suspend.target hibernate.target hybrid-sleep.target

[Service]
Type=oneshot
ExecStart=/bin/bash -c 'echo balanced > /sys/firmware/acpi/platform_profile 2>/dev/null || true'
EOF
systemctl enable fix-cpu-throttle.service

echo "=== GalaxyOS Setup Complete ==="
date
